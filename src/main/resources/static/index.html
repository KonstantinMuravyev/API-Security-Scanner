<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTB API Security Scanner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .upload-area {
            border: 3px dashed #bdc3c7;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }
        .upload-area.drag-over {
            border-color: #667eea;
            background: #e8eaf6;
        }
        input[type="file"] {
            display: none;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .options {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .option {
            margin: 10px 0;
        }
        .option label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .option input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }
        .option input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 5px;
        }
        .impact-summary {
            margin-top: 20px;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .impact-summary h3 {
            margin-bottom: 12px;
            font-size: 16px;
            color: #2c3e50;
        }
        .impact-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 4px 8px 4px 0;
            padding: 4px 12px;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            border: 1px solid transparent;
            letter-spacing: 0.4px;
        }
        .impact-chip.CRITICAL { background: #fdecea; color: #c0392b; border-color: rgba(192, 57, 43, 0.35); }
        .impact-chip.HIGH { background: #fff3e0; color: #d35400; border-color: rgba(211, 84, 0, 0.35); }
        .impact-chip.MEDIUM { background: #fff8e1; color: #f39c12; border-color: rgba(243, 156, 18, 0.35); }
        .impact-chip.LOW { background: #e3f2fd; color: #1976d2; border-color: rgba(25, 118, 210, 0.35); }
        .impact-chip.INFO { background: #f4f6f8; color: #607d8b; border-color: rgba(96, 125, 139, 0.35); }
        .result {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        .result.show {
            display: block;
        }
        .stat {
            display: inline-block;
            margin: 10px 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
        }
        .critical { color: #e74c3c; }
        .high { color: #e67e22; }
        .medium { color: #f39c12; }
        .low { color: #3498db; }
        .loading {
            text-align: center;
            padding: 30px;
            display: none;
        }
        .loading.show {
            display: block;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            margin-top: 15px;
            padding: 15px;
            background: #ffeaea;
            border-left: 4px solid #e74c3c;
            border-radius: 6px;
            color: #c0392b;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .upload-section {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>VTB API Security Scanner</h1>
    <p class="subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ API</p>

    <div class="upload-section">
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div id="uploadContent">
                <div style="font-size: 32px; margin-bottom: 15px; color: #667eea;">üìÑ</div>
                <div style="font-size: 18px; margin-bottom: 10px;">
                    <strong>–ó–∞–≥—Ä—É–∑–∏—Ç–µ OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é</strong>
                </div>
                <div style="color: #7f8c8d;">
                    –ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ YAML/JSON —Ñ–∞–π–ª—ã
                </div>
            </div>
            <input type="file" id="fileInput" accept=".yaml,.yml,.json" multiple onchange="handleFileSelect(event)">
        </div>
        <div id="fileList" style="margin-top: 10px; display: none;"></div>
    </div>

    <div style="margin: 20px 0; text-align: center; color: #7f8c8d;">
        <strong>–∏–ª–∏</strong>
    </div>

    <div class="option" style="margin-bottom: 20px;">
        <label>URL (—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–ª–∏ —Ü–µ–ª–µ–≤–æ–π API):</label>
        <div id="urlList" style="margin-top: 10px;"></div>
        <div style="margin-top: 10px;">
            <button type="button" onclick="addUrl()" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-right: 10px;">
                + –î–æ–±–∞–≤–∏—Ç—å URL
            </button>
        </div>
        <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
            –ï—Å–ª–∏ —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, —É–∫–∞–∂–∏—Ç–µ URL —Ü–µ–ª–µ–≤–æ–≥–æ API. –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç, URL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ target URL.
        </div>
    </div>

    <button class="btn" id="scanBtn" onclick="scanAPI()" disabled>
        –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    </button>

    <div class="error-message" id="errorMessage"></div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ API...</div>
    </div>

    <div class="result" id="result">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <div id="stats"></div>
        <div style="margin-top: 20px;">
            <button class="btn" onclick="downloadReport('json')" style="width: 48%; display: inline-block; margin-right: 4%;">
                –°–∫–∞—á–∞—Ç—å JSON
            </button>
            <button class="btn" onclick="downloadReport('html')" style="width: 48%; display: inline-block;">
                –û—Ç–∫—Ä—ã—Ç—å HTML –æ—Ç—á–µ—Ç
            </button>
        </div>
        <div id="attackSurfaceBtn" style="margin-top: 15px; display: none;">
            <button class="btn" id="attackSurfaceBtnElem" onclick="loadAttackSurface()" style="width: 100%; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                –ü–æ—Å—Ç—Ä–æ–∏—Ç—å Attack Surface Map
            </button>
        </div>
    </div>
</div>

<script>
    let currentFiles = [];
    let scanResults = [];
    let currentUrls = [];

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π URL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    function initUrls() {
        if (currentUrls.length === 0) {
            currentUrls.push('');
            updateUrlList();
        }
    }

    function addUrl() {
        currentUrls.push('');
        updateUrlList();
    }

    function removeUrl(index) {
        currentUrls.splice(index, 1);
        updateUrlList();
        updateScanButton();
    }

    function updateUrlList() {
        const urlListDiv = document.getElementById('urlList');
        urlListDiv.innerHTML = currentUrls.map((url, index) => `
                <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <input type="text"
                           id="urlInput_${index}"
                           value="${url}"
                           placeholder="https://petstore.swagger.io/v2/swagger.json"
                           style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;"
                           onchange="currentUrls[${index}] = this.value; updateScanButton();">
                    ${currentUrls.length > 1 ? `
                        <button onclick="removeUrl(${index})" style="background: #e74c3c; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            - –£–¥–∞–ª–∏—Ç—å
                        </button>
                    ` : ''}
                </div>
            `).join('');
        updateScanButton();
    }

    function getValidUrls() {
        return currentUrls.filter(url => url && url.trim() !== '').map(url => url.trim());
    }

    // Drag & Drop
    const uploadArea = document.getElementById('uploadArea');

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');

        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });

    function handleFileSelect(event) {
        const files = Array.from(event.target.files);
        handleFiles(files);
    }

    function handleFiles(files) {
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
        const validFiles = files.filter(file => {
            const name = (file.name || '').toLowerCase();
            return name.endsWith('.yaml') || name.endsWith('.yml') || name.endsWith('.json');
        });

        if (validFiles.length === 0) {
            showError('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .yaml, .yml –∏–ª–∏ .json');
            return;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
        currentFiles.push(...validFiles);
        updateFileList();
        updateScanButton();
    }

    function removeFile(index) {
        currentFiles.splice(index, 1);
        updateFileList();
        updateScanButton();
    }

    function updateFileList() {
        const fileListDiv = document.getElementById('fileList');

        if (currentFiles.length === 0) {
            fileListDiv.style.display = 'none';
            document.getElementById('uploadContent').innerHTML = `
                    <div style="font-size: 32px; margin-bottom: 15px; color: #667eea;">üìÑ</div>
                <div style="font-size: 18px; margin-bottom: 10px;">
                        <strong>–ó–∞–≥—Ä—É–∑–∏—Ç–µ OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é</strong>
                    </div>
                    <div style="color: #7f8c8d;">
                        –ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ YAML/JSON —Ñ–∞–π–ª—ã
                    </div>
                `;
            return;
        }

        fileListDiv.style.display = 'block';
        fileListDiv.innerHTML = currentFiles.map((file, index) => `
                <div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600; color: #27ae60;">${file.name}</span>
                    <button onclick="removeFile(${index})" style="background: #e74c3c; color: white; border: none; padding: 5px 15px; border-radius: 6px; cursor: pointer; font-size: 14px;">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');

        document.getElementById('uploadContent').innerHTML = `
                <div style="font-size: 32px; margin-bottom: 15px; color: #27ae60;">‚úì</div>
                <div style="font-size: 18px; margin-bottom: 10px;">
                    <strong>${currentFiles.length} —Ñ–∞–π–ª${currentFiles.length > 1 ? '–∞' : ''} –≥–æ—Ç–æ–≤${currentFiles.length > 1 ? '—ã' : ''} –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é</strong>
                </div>
            `;
    }

    function updateScanButton() {
        const hasFiles = currentFiles.length > 0;
        const hasUrls = getValidUrls().length > 0;
        document.getElementById('scanBtn').disabled = !(hasFiles || hasUrls);
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ URL –ø–æ–ª—è—Ö
    function initUrlListeners() {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç —á–µ—Ä–µ–∑ onchange –≤ updateUrlList
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        initUrls();
    });

    function hideError() {
        document.getElementById('errorMessage').classList.remove('show');
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = '–û—à–∏–±–∫–∞: ' + message;
        errorDiv.classList.add('show');
        setTimeout(hideError, 10000); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
    }

    async function scanAPI() {
        const hasFiles = currentFiles.length > 0;
        const validUrls = getValidUrls();

        if (!hasFiles && validUrls.length === 0) {
            showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª(—ã) –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ URL —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤ –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        if (hasFiles) {
            for (const file of currentFiles) {
                const name = (file.name || '').toLowerCase();
                if (!file.name ||
                    (!name.endsWith('.yaml') &&
                        !name.endsWith('.yml') &&
                        !name.endsWith('.json'))) {
                    showError(`–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: ${file.name}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .yaml, .yml –∏–ª–∏ .json`);
                    return;
                }

                if (file.size === 0) {
                    showError(`–§–∞–π–ª –ø—É—Å—Ç: ${file.name}`);
                    return;
                }

                if (file.size > 100 * 1024 * 1024) {
                    showError(`–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π: ${file.name} (–º–∞–∫—Å–∏–º—É–º 100 MB). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CLI –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤.`);
                    return;
                }
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å URL –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã
        for (const url of validUrls) {
            if (!url.match(/^https?:\/\/.+/)) {
                showError(`–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç URL: ${url}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ http:// –∏–ª–∏ https://`);
                return;
            }
        }

        document.getElementById('result').classList.remove('show');
        hideError();
        document.getElementById('loading').classList.add('show');
        document.getElementById('scanBtn').disabled = true;

        try {
            let response;

            if (hasFiles) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π URL –∫–∞–∫ targetUrl –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
                const targetUrl = validUrls.length > 0 ? validUrls[0] : null;

                // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –µ—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –±–æ–ª—å—à–µ 1
                if (currentFiles.length > 1) {
                    const formData = new FormData();
                    for (const file of currentFiles) {
                        formData.append('files', file);
                    }
                    formData.append('enableGost', 'true');
                    formData.append('enableFuzzing', 'true');

                    if (targetUrl) {
                        formData.append('targetUrl', targetUrl);
                    }

                    response = await fetch('/api/v1/scan-multiple', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('–û—à–∏–±–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ' + response.status);
                    }

                    const multipleResults = await response.json();
                    scanResults = (multipleResults.results || [])
                        .filter(r => r.success && r.result)
                        .map(r => r.result);
                    document.getElementById('loading').classList.remove('show');
                    showMultipleResults(multipleResults);
                    document.getElementById('scanBtn').disabled = false;
                    return;
                } else {
                    // –û–¥–∏–Ω–æ—á–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                    const formData = new FormData();
                    formData.append('file', currentFiles[0]);
                    formData.append('enableGost', 'true');
                    formData.append('enableFuzzing', 'true');

                    if (targetUrl) {
                        formData.append('targetUrl', targetUrl);
                    }

                    response = await fetch('/api/v1/scan', {
                        method: 'POST',
                        body: formData
                    });
                }
            } else {
                // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ URL - —Å–∫–∞–Ω–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π URL
                if (validUrls.length === 1) {
                    // –û–¥–∏–Ω–æ—á–Ω—ã–π URL
                    const requestBody = {
                        specUrl: validUrls[0],
                        targetUrl: validUrls[0],
                        enableGost: true,
                        enableFuzzing: true
                    };

                    response = await fetch('/api/v1/scan-url', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                } else {
                    // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ URL - —Å–∫–∞–Ω–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
                    const promises = validUrls.map(url =>
                        fetch('/api/v1/scan-url', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                specUrl: url,
                                targetUrl: url,
                                enableGost: true,
                                enableFuzzing: true
                            })
                        }).then(r => r.json())
                    );

                    const results = await Promise.all(promises);
                    const multipleResults = {
                        results: results.map((result, index) => ({
                            filename: validUrls[index],
                            result: result,
                            success: result && !result.error
                        })),
                        total: results.length,
                        successful: results.filter(r => r && !r.error).length
                    };

                    scanResults = results.filter(r => r && !r.error);
                    document.getElementById('loading').classList.remove('show');
                    showMultipleResults(multipleResults);
                    document.getElementById('scanBtn').disabled = false;
                    return;
                }
            }

            if (!response.ok) {
                let errorText = await response.text();
                let errorMessage = '–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ' + response.status;

                try {
                    const errorJson = JSON.parse(errorText);
                    if (errorJson.error) {
                        errorMessage = errorJson.error;
                    }
                } catch (e) {
                    if (errorText) {
                        errorMessage = errorText.length > 200 ? errorText.substring(0, 200) + '...' : errorText;
                    }
                }

                throw new Error(errorMessage);
            }

            const result = await response.json();
            scanResults = [result];
            document.getElementById('loading').classList.remove('show');
            showResults(result);

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
            let errorMsg = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            if (errorMsg.includes('Failed to fetch') || errorMsg.includes('NetworkError')) {
                errorMsg = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.';
            } else if (errorMsg.includes('JSON')) {
                errorMsg = '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞. –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–∞–π–ª –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.';
            }
            showError(errorMsg);
            document.getElementById('loading').classList.remove('show');
            document.getElementById('scanBtn').disabled = false;
        }
    }

    function showMultipleResults(multipleResults) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ downloadReportForFile
        window.lastMultipleResults = multipleResults;

        const results = multipleResults.results || [];
        const statsHtml = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="margin-bottom: 10px;">
                        <strong>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ:</strong> ${multipleResults.successful || 0} –∏–∑ ${multipleResults.total || 0} —Ñ–∞–π–ª–æ–≤ —É—Å–ø–µ—à–Ω–æ
                    </div>
                </div>
            `;

        let resultsHtml = statsHtml;

        results.forEach((fileResult, index) => {
            const filename = fileResult.filename || `–§–∞–π–ª ${index + 1}`;
            const success = fileResult.success === true;

            if (success && fileResult.result) {
                const result = fileResult.result;
                const stats = result.statistics || {};
                const hasRiskMetrics = stats && (Number.isFinite(stats.maxRiskScore) || Number.isFinite(stats.averageRiskScore));
                const impactSummary = stats ? (stats.impactSummary || stats.impact_summary) : null;
                const gostCount = (result.vulnerabilities || []).filter(v => v.gostRelated).length;
                const tlsCount = (result.vulnerabilities || []).filter(v => v.id && v.id.startsWith('TLS-')).length;
                const riskBlock = hasRiskMetrics ? `
                        <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 15px;">
                            <div style="flex: 1; min-width: 160px; background: #eef2ff; border-radius: 8px; padding: 12px;">
                                <div style="font-size: 24px; font-weight: 700; color: #3f51b5;">${Number.isFinite(stats.maxRiskScore) ? stats.maxRiskScore : 'N/A'}</div>
                                <div style="color: #5c6bc0; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Max Risk Score</div>
                            </div>
                            <div style="flex: 1; min-width: 160px; background: #f3f4f6; border-radius: 8px; padding: 12px;">
                                <div style="font-size: 24px; font-weight: 700; color: #37474f;">${Number.isFinite(stats.averageRiskScore) ? Number(stats.averageRiskScore).toFixed(1) : 'N/A'}</div>
                                <div style="color: #607d8b; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Average Risk Score</div>
                </div>
                        </div>` : '';
                const impactBlock = impactSummary && Object.keys(impactSummary).length > 0
                    ? `<div class="impact-summary" style="margin-top: 10px;">
                                <h3>Impact Highlights</h3>
                                ${renderImpactChips(impactSummary)}
                           </div>`
                    : '';
                const gostBlock = gostCount > 0 ? `
                <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <strong>–ì–û–°–¢ –Ω–∞—Ä—É—à–µ–Ω–∏–π:</strong> ${gostCount}
                </div>` : '';
                const tlsBlock = tlsCount > 0 ? `
                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <strong>TLS –ø—Ä–æ–±–ª–µ–º:</strong> ${tlsCount}
                </div>` : '';
                resultsHtml += `
                        <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #2196F3;">
                            <h3 style="margin-bottom: 10px;">${filename}</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="stat">
                                    <div class="stat-number critical">${stats.criticalVulnerabilities || 0}</div>
                        <div class="stat-label">CRITICAL</div>
                    </div>
                    <div class="stat">
                                    <div class="stat-number high">${stats.highVulnerabilities || 0}</div>
                        <div class="stat-label">HIGH</div>
                    </div>
                    <div class="stat">
                                    <div class="stat-number medium">${stats.mediumVulnerabilities || 0}</div>
                        <div class="stat-label">MEDIUM</div>
                    </div>
                    <div class="stat">
                                    <div class="stat-number low">${stats.lowVulnerabilities || 0}</div>
                        <div class="stat-label">LOW</div>
                    </div>
                </div>
                            ${riskBlock}
                            ${impactBlock}
                    ${gostBlock}
                    ${tlsBlock}
                            <button class="btn" onclick="downloadReportForFile('${filename}', '${filename}')" style="width: 100%; margin-top: 10px;">
                                –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç: ${filename}
                            </button>
                        </div>
                    `;
            } else {
                resultsHtml += `
                        <div style="margin-top: 20px; padding: 15px; background: #ffeaea; border-radius: 8px; border-left: 4px solid #e74c3c;">
                            <h3 style="margin-bottom: 10px;">${filename}</h3>
                            <div style="color: #c0392b;">–û—à–∏–±–∫–∞: ${fileResult.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>
                </div>
            `;
            }
        });

        document.getElementById('stats').innerHTML = resultsHtml;
        document.getElementById('result').classList.add('show');
        document.getElementById('scanBtn').disabled = false;
    }

    function downloadReportForFile(filename, filenameKey) {
        // –ù–∞—Ö–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏–∑ multipleResults
        const multipleResults = window.lastMultipleResults || { results: [] };
        const fileResult = multipleResults.results.find(r => r.filename === filenameKey);

        if (!fileResult || !fileResult.result) {
            // Fallback: –∏—â–µ–º –≤ scanResults –ø–æ apiName
            const result = scanResults.find(r => r && r.apiName === filenameKey) ||
                (scanResults.length > 0 ? scanResults[0] : null);

            if (!result) {
                showError('–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            const safeFilename = filename.replace(/[^a-zA-Z0-9.-]/g, '_');
            const blob = new Blob([JSON.stringify(result, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scan-report-${safeFilename}.json`;
            a.click();
            URL.revokeObjectURL(url);
            return;
        }

        const result = fileResult.result;
        const safeFilename = filename.replace(/[^a-zA-Z0-9.-]/g, '_');

        const blob = new Blob([JSON.stringify(result, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `scan-report-${safeFilename}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function showResults(result) {
        const stats = result.statistics || {};

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç null
        let statsHtml = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="margin-bottom: 10px;">
                        <strong>API:</strong> ${result.apiName || 'Unknown'} v${result.apiVersion || 'Unknown'}<br>
                        <strong>URL:</strong> ${result.targetUrl || 'N/A'}<br>
                        <strong>–í—Ä–µ–º—è:</strong> ${stats.scanDurationMs || 0} –º—Å<br>
                        ${result.apiContext ? `<strong>–ö–æ–Ω—Ç–µ–∫—Å—Ç:</strong> ${result.apiContext}<br>` : ''}
                        ${result.apiHealthScore !== undefined ? `<strong>Health Score:</strong> ${result.apiHealthScore}/100` : ''}
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat">
                        <div class="stat-number critical">${stats.criticalVulnerabilities || 0}</div>
                        <div class="stat-label">CRITICAL</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number high">${stats.highVulnerabilities || 0}</div>
                        <div class="stat-label">HIGH</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number medium">${stats.mediumVulnerabilities || 0}</div>
                        <div class="stat-label">MEDIUM</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number low">${stats.lowVulnerabilities || 0}</div>
                        <div class="stat-label">LOW</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" style="color: #95a5a6;">${stats.infoVulnerabilities || 0}</div>
                        <div class="stat-label">INFO</div>
                    </div>
                </div>
            `;

        const hasRiskMetrics = stats.maxRiskScore !== undefined || stats.averageRiskScore !== undefined;
        if (hasRiskMetrics) {
            const maxRisk = Number.isFinite(stats.maxRiskScore) ? stats.maxRiskScore : 'N/A';
            const averageRisk = Number.isFinite(stats.averageRiskScore)
                ? Number(stats.averageRiskScore).toFixed(1)
                : 'N/A';
            statsHtml += `
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px;">
                        <div style="flex: 1; min-width: 180px; background: #eef2ff; border-radius: 8px; padding: 14px;">
                            <div style="font-size: 28px; font-weight: 700; color: #3f51b5;">${maxRisk}</div>
                            <div style="color: #5c6bc0; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Max Risk Score</div>
                        </div>
                        <div style="flex: 1; min-width: 180px; background: #f3f4f6; border-radius: 8px; padding: 14px;">
                            <div style="font-size: 28px; font-weight: 700; color: #37474f;">${averageRisk}</div>
                            <div style="color: #607d8b; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Average Risk Score</div>
                        </div>
                    </div>
                `;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ì–û–°–¢ –µ—Å–ª–∏ –µ—Å—Ç—å
        if (result.vulnerabilities && result.vulnerabilities.length > 0) {
            const gostCount = result.vulnerabilities.filter(v => v.gostRelated).length;
            if (gostCount > 0) {
                statsHtml += `
                        <div style="margin-bottom: 20px; padding: 10px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
                            <strong>–ì–û–°–¢ –Ω–∞—Ä—É—à–µ–Ω–∏–π:</strong> ${gostCount}
                        </div>
                    `;
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ TLS –µ—Å–ª–∏ –µ—Å—Ç—å
        if (result.vulnerabilities && result.vulnerabilities.length > 0) {
            const tlsVulns = result.vulnerabilities.filter(v => v.id && v.id.startsWith('TLS-'));
            if (tlsVulns.length > 0) {
                statsHtml += `
                        <div style="margin-bottom: 20px; padding: 10px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <strong>TLS –ø—Ä–æ–±–ª–µ–º:</strong> ${tlsVulns.length}
                        </div>
                    `;
            }
        }

        const impactSummary = stats.impactSummary || stats.impact_summary || {};
        if (impactSummary && Object.keys(impactSummary).length > 0) {
            statsHtml += `
                    <div class="impact-summary">
                        <h3>Impact Highlights</h3>
                        ${renderImpactChips(impactSummary)}
                    </div>
                `;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (—Ç–æ–ª—å–∫–æ –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏)
        if (result.vulnerabilities && result.vulnerabilities.length > 0) {
            // –ö–†–ò–¢–ò–ß–ù–û: –î–æ–±–∞–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏!
            const severityCounts = {
                'CRITICAL': result.vulnerabilities.filter(v => v.severity === 'CRITICAL').length,
                'HIGH': result.vulnerabilities.filter(v => v.severity === 'HIGH').length,
                'MEDIUM': result.vulnerabilities.filter(v => v.severity === 'MEDIUM').length,
                'LOW': result.vulnerabilities.filter(v => v.severity === 'LOW').length,
                'INFO': result.vulnerabilities.filter(v => v.severity === 'INFO').length
            };

            statsHtml += `
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px;">–§–∏–ª—å—Ç—Ä—ã –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <button class="filter-btn active" data-filter="severity" data-value="all" onclick="applyVulnFilters('severity', 'all', result, this)" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 5px; font-weight: 500;">–í—Å–µ (${result.vulnerabilities.length})</button>
                            <button class="filter-btn" data-filter="severity" data-value="CRITICAL" onclick="applyVulnFilters('severity', 'CRITICAL', result, this)" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 5px; font-weight: 500;">Critical (${severityCounts['CRITICAL']})</button>
                            <button class="filter-btn" data-filter="severity" data-value="HIGH" onclick="applyVulnFilters('severity', 'HIGH', result, this)" style="background: #e67e22; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 5px; font-weight: 500;">High (${severityCounts['HIGH']})</button>
                            <button class="filter-btn" data-filter="severity" data-value="MEDIUM" onclick="applyVulnFilters('severity', 'MEDIUM', result, this)" style="background: #f39c12; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 5px; font-weight: 500;">Medium (${severityCounts['MEDIUM']})</button>
                            <button class="filter-btn" data-filter="severity" data-value="LOW" onclick="applyVulnFilters('severity', 'LOW', result, this)" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 5px; font-weight: 500;">Low (${severityCounts['LOW']})</button>
                            <button class="filter-btn" data-filter="severity" data-value="INFO" onclick="applyVulnFilters('severity', 'INFO', result, this)" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">Info (${severityCounts['INFO']})</button>
                        </div>
                    </div>
                `;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-5)
        if (result.vulnerabilities && result.vulnerabilities.length > 0) {
            const topVulns = result.vulnerabilities
                .filter(v => v.severity === 'CRITICAL' || v.severity === 'HIGH')
                .slice(0, 5);

            if (topVulns.length > 0) {
                statsHtml += `
                        <div id="vulnerabilities-list" style="margin-top: 20px;">
                            <h3 style="margin-bottom: 15px;">–£—è–∑–≤–∏–º–æ—Å—Ç–∏:</h3>
                            <div id="vuln-cards-container" style="max-height: 400px; overflow-y: auto;">
                    `;

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                window.currentVulnerabilities = result.vulnerabilities;
                window.currentFilters = { severity: 'all' };

                topVulns.forEach(vuln => {
                    const severityColor = vuln.severity === 'CRITICAL' ? '#e74c3c' : '#e67e22';
                    const impactChip = vuln.impactLevel
                        ? `<span class="impact-chip ${classifyImpactSeverity(vuln.impactLevel)}">${escapeHtml(vuln.impactLevel)}</span>`
                        : '';
                    const title = escapeHtml(vuln.title || '–£—è–∑–≤–∏–º–æ—Å—Ç—å');
                    const endpoint = escapeHtml(vuln.endpoint || 'N/A');
                    const method = escapeHtml(vuln.method || 'N/A');
                    const severity = escapeHtml(vuln.severity || 'UNKNOWN');
                    const descriptionText = vuln.description || '';
                    const shortDescription = descriptionText.length > 200
                        ? `${descriptionText.substring(0, 200)}...`
                        : descriptionText;
                    const description = descriptionText
                        ? `<div style="margin-top: 8px; font-size: 14px;">${escapeHtml(shortDescription)}</div>`
                        : '';
                    const riskScore = Number.isFinite(vuln.riskScore) ? Number(vuln.riskScore) : null;
                    const evidenceText = vuln.evidence || '';
                    const evidenceSnippet = evidenceText
                        ? `<div style="margin-top: 8px; font-size: 13px; color: #555;"><strong>Evidence:</strong> ${escapeHtml(evidenceText.length > 180 ? `${evidenceText.substring(0, 180)}...` : evidenceText)}</div>`
                        : '';
                    statsHtml += `
                            <div style="margin-bottom: 15px; padding: 15px; background: #fafafa; border-left: 4px solid ${severityColor}; border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <strong>${title}</strong>
                                    <span style="background: ${severityColor}; color: white; padding: 3px 10px; border-radius: 4px; font-size: 12px;">
                                        ${severity}
                                    </span>
                                </div>
                                ${impactChip ? `<div style="margin-bottom: 6px;">${impactChip}</div>` : ''}
                                <div style="color: #7f8c8d; font-size: 14px; margin-bottom: 5px;">
                                    <strong>–≠–Ω–¥–ø–æ–∏–Ω—Ç:</strong> ${endpoint} [${method}]
                                </div>
                                ${riskScore !== null ? `<div style="color: #7f8c8d; font-size: 14px; margin-bottom: 5px;"><strong>Risk Score:</strong> ${riskScore}</div>` : ''}
                                ${vuln.cwe ? `<div style="color: #7f8c8d; font-size: 14px; margin-bottom: 5px;"><strong>CWE:</strong> ${escapeHtml(vuln.cwe)}</div>` : ''}
                                ${description}
                                ${evidenceSnippet}
                            </div>
                        `;
                });

                statsHtml += `
                            </div>
                        </div>
                    `;

                // –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ innerHTML)
                setTimeout(() => {
                    renderVulnerabilities(result.vulnerabilities, { severity: 'all' });
                }, 0);
            }
        }

        document.getElementById('stats').innerHTML = statsHtml;
        document.getElementById('result').classList.add('show');
        document.getElementById('scanBtn').disabled = false;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É Attack Surface –µ—Å–ª–∏ –µ—Å—Ç—å targetUrl
        if (result.targetUrl) {
            document.getElementById('attackSurfaceBtn').style.display = 'block';
        }
    }

    function downloadReport(format) {
        if (!scanResults || scanResults.length === 0) {
            showError('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
            return;
        }

        const result = scanResults[0]; // –î–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

        if (format === 'json') {
            const filename = result.apiName ? result.apiName.replace(/[^a-zA-Z0-9.-]/g, '_') : 'scan-report';
            const blob = new Blob([JSON.stringify(result, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scan-report-${filename}.json`;
            a.click();
            URL.revokeObjectURL(url);
        } else if (format === 'html') {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –æ—Ç—á–µ—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
            const html = generateHtmlReport(result);
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        }
    }

    async function loadAttackSurface() {
        const btn = document.getElementById('attackSurfaceBtnElem');
        if (btn && btn.disabled) {
            return; // –£–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
        }

        const validUrls = getValidUrls();
        const hasResultUrl = scanResults && scanResults.length > 0 && scanResults[0].targetUrl;

        if (validUrls.length === 0 && !hasResultUrl) {
            showError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å URL —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è Attack Surface');
            return;
        }

        try {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
            if (btn) {
                btn.disabled = true;
                btn.textContent = '–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ Attack Surface...';
            }

            document.getElementById('loading').classList.add('show');
            const url = validUrls.length > 0 ? validUrls[0] : (scanResults[0] && scanResults[0].targetUrl);
            const response = await fetch(`/api/v1/attack-surface?specUrl=${encodeURIComponent(url)}`);

            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ Attack Surface');
            }

            const surface = await response.json();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã Attack Surface
            showAttackSurface(surface);

            document.getElementById('loading').classList.remove('show');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ Attack Surface: ' + error.message);
            document.getElementById('loading').classList.remove('show');
        } finally {
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            if (btn) {
                btn.disabled = false;
                btn.textContent = '–ü–æ—Å—Ç—Ä–æ–∏—Ç—å Attack Surface Map';
            }
        }
    }

    function showAttackSurface(surface) {
        const statsHtml = `
                <div style="margin-top: 30px; padding: 20px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <h3 style="margin-bottom: 15px;">Attack Surface Map</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: bold; color: #2196F3;">${surface.nodes ? Object.keys(surface.nodes).length : 0}</div>
                            <div style="color: #7f8c8d; font-size: 14px;">–≠–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: bold; color: #e74c3c;">${surface.entryPoints ? surface.entryPoints.length : 0}</div>
                            <div style="color: #7f8c8d; font-size: 14px;">–¢–æ—á–µ–∫ –≤—Ö–æ–¥–∞</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: bold; color: #f39c12;">${surface.attackChains ? surface.attackChains.length : 0}</div>
                            <div style="color: #7f8c8d; font-size: 14px;">–¶–µ–ø–æ—á–µ–∫ –∞—Ç–∞–∫</div>
                        </div>
                    </div>
                    ${surface.entryPoints && surface.entryPoints.length > 0 ? `
                        <div style="margin-top: 20px;">
                            <h4>–¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ (–±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏):</h4>
                            <ul style="margin-top: 10px;">
                                ${surface.entryPoints.map(ep => `<li style="margin: 5px 0; padding: 8px; background: #ffe6e6; border-radius: 4px;">${ep}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${surface.attackChains && surface.attackChains.length > 0 ? `
                        <div style="margin-top: 20px;">
                            <h4>–¶–µ–ø–æ—á–∫–∏ –∞—Ç–∞–∫:</h4>
                            ${surface.attackChains.map(chain => `
                                <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                                    <strong>${chain.target || 'N/A'}</strong><br>
                                    <strong>–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:</strong> <span style="color: ${chain.severity === 'CRITICAL' ? '#e74c3c' : '#f39c12'};">${chain.severity || 'UNKNOWN'}</span><br>
                                    <strong>–®–∞–≥–∏:</strong>
                                    <ol style="margin-top: 10px; margin-left: 20px;">
                                        ${chain.steps ? chain.steps.map(step => `<li style="margin: 5px 0;">${step}</li>`).join('') : ''}
                                    </ol>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;

        document.getElementById('stats').innerHTML += statsHtml;
    }

    // –§—É–Ω–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
    function applyVulnFilters(filterType, value, result, buttonElement) {
        if (!window.currentVulnerabilities) {
            window.currentVulnerabilities = result.vulnerabilities || [];
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –≤ –≥—Ä—É–ø–ø–µ
        const group = buttonElement.closest('div');
        if (group) {
            group.querySelectorAll(`.filter-btn[data-filter="${filterType}"]`).forEach(btn => {
                btn.classList.remove('active');
            });
        }
        buttonElement.classList.add('active');

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        if (!window.currentFilters) {
            window.currentFilters = { severity: 'all' };
        }
        window.currentFilters[filterType] = value;

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        renderVulnerabilities(window.currentVulnerabilities, window.currentFilters);
    }

    function renderVulnerabilities(vulnerabilities, filters) {
        const container = document.getElementById('vuln-cards-container');
        if (!container) return;

        let filtered = vulnerabilities;

        // –§–∏–ª—å—Ç—Ä –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏
        if (filters.severity && filters.severity !== 'all') {
            filtered = filtered.filter(v => v.severity === filters.severity);
        }

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ (–±–µ–∑ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
        filtered.sort((a, b) => {
            const severityOrder = { 'CRITICAL': 1, 'HIGH': 2, 'MEDIUM': 3, 'LOW': 4, 'INFO': 5 };
            const severityA = severityOrder[a.severity] || 6;
            const severityB = severityOrder[b.severity] || 6;
            return severityA - severityB;
        });

        // –†–µ–Ω–¥–µ—Ä–∏–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏
        container.innerHTML = filtered.map(vuln => {
            const severityColor = {
                'CRITICAL': '#e74c3c',
                'HIGH': '#e67e22',
                'MEDIUM': '#f39c12',
                'LOW': '#3498db',
                'INFO': '#95a5a6'
            }[vuln.severity] || '#95a5a6';

            const impactChip = vuln.impactLevel
                ? `<span class="impact-chip ${classifyImpactSeverity(vuln.impactLevel)}">${escapeHtml(vuln.impactLevel)}</span>`
                : '';
            const title = escapeHtml(vuln.title || '–£—è–∑–≤–∏–º–æ—Å—Ç—å');
            const endpoint = escapeHtml(vuln.endpoint || 'N/A');
            const method = escapeHtml(vuln.method || 'N/A');
            const severity = escapeHtml(vuln.severity || 'UNKNOWN');
            const cwe = vuln.cwe
                ? `<div style="color: #7f8c8d; font-size: 14px; margin-bottom: 5px;"><strong>CWE:</strong> ${escapeHtml(vuln.cwe)}</div>`
                : '';
            const priority = Number.isFinite(vuln.priority)
                ? `<div style="color: #7f8c8d; font-size: 14px; margin-bottom: 5px;"><strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong> P${escapeHtml(vuln.priority)}</div>`
                : '';
            const riskScore = Number.isFinite(vuln.riskScore)
                ? `<div style="color: #7f8c8d; font-size: 14px; margin-bottom: 5px;"><strong>Risk Score:</strong> ${escapeHtml(vuln.riskScore)}</div>`
                : '';
            const evidence = vuln.evidence
                ? `<div style="margin-top: 8px; font-size: 13px; color: #555;"><strong>Evidence:</strong> ${escapeHtml(vuln.evidence.length > 220 ? `${vuln.evidence.substring(0, 220)}...` : vuln.evidence)}</div>`
                : '';
            const descriptionText = vuln.description || '';
            const shortDescription = descriptionText.length > 200
                ? `${descriptionText.substring(0, 200)}...`
                : descriptionText;
            const description = descriptionText
                ? `<div style="margin-top: 8px; font-size: 14px;">${escapeHtml(shortDescription)}</div>`
                : '';

            return `
                    <div class="vuln-card" style="margin-bottom: 15px; padding: 15px; background: #fafafa; border-left: 4px solid ${severityColor}; border-radius: 4px;" data-priority="${vuln.priority || 5}" data-severity="${vuln.severity || 'INFO'}">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <strong>${title}</strong>
                            <span style="background: ${severityColor}; color: white; padding: 3px 10px; border-radius: 4px; font-size: 12px;">
                                ${severity}
                            </span>
                        </div>
                        ${impactChip ? `<div style="margin-bottom: 6px;">${impactChip}</div>` : ''}
                        <div style="color: #7f8c8d; font-size: 14px; margin-bottom: 5px;">
                            <strong>–≠–Ω–¥–ø–æ–∏–Ω—Ç:</strong> ${endpoint} [${method}]
                        </div>
                        ${priority}
                        ${riskScore}
                        ${cwe}
                        ${description}
                        ${evidence}
                    </div>
                `;
        }).join('');

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        const countElement = container.parentElement.querySelector('h3');
        if (countElement) {
            countElement.textContent = `–£—è–∑–≤–∏–º–æ—Å—Ç–∏ (${filtered.length} –∏–∑ ${vulnerabilities.length}):`;
        }
    }

    function escapeHtml(value) {
        if (!value && value !== 0) {
            return '';
        }
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function classifyImpactSeverity(label) {
        if (!label) {
            return 'INFO';
        }
        const lower = label.toLowerCase();
        if (lower.includes('treasury_flow') || lower.includes('financial_fraud') ||
            lower.includes('payout_flow') || lower.includes('gov_flow') ||
            lower.includes('consent_flow') || lower.includes('loan_flow')) {
            return 'CRITICAL';
        }
        if (lower.includes('order_flow') || lower.includes('marketplace_abuse') ||
            lower.includes('onboarding_flow') || lower.includes('auth_abuse') ||
            lower.includes('password_reset') || lower.includes('session_flow') ||
            lower.includes('refund_flow')) {
            return 'HIGH';
        }
        if (lower.includes('dos_risk') || lower.includes('abuse') ||
            lower.includes('session') || lower.includes('impact') ||
            lower.includes('risk')) {
            return 'MEDIUM';
        }
        return 'INFO';
    }

    function renderImpactChips(summary) {
        if (!summary) {
            return '';
        }
        return Object.entries(summary)
            .sort((a, b) => b[1] - a[1])
            .map(([label, count]) => {
                const severityClass = classifyImpactSeverity(label);
                return `<span class="impact-chip ${severityClass}">
                    ${escapeHtml(label)} <strong>${count}</strong>
                </span>`;
            })
            .join('');
    }

    function generateHtmlReport(result) {
        // –ü—Ä–æ—Å—Ç–æ–π HTML –æ—Ç—á–µ—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
        return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>API Security Scan Report</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .header { background: #667eea; color: white; padding: 20px; border-radius: 8px; }
        .stat { display: inline-block; margin: 10px; padding: 15px; background: #f5f5f5; border-radius: 8px; }
        .vuln { margin: 15px 0; padding: 15px; border-left: 4px solid #e74c3c; background: #fafafa; }
    </style>
</head>
<body>
    <div class="header">
        <h1>API Security Scan Report</h1>
        <p>API: ${result.apiName || 'Unknown'} v${result.apiVersion || 'Unknown'}</p>
        <p>URL: ${result.targetUrl || 'N/A'}</p>
    </div>
    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <div>
        <div class="stat">CRITICAL: ${result.statistics ? result.statistics.criticalVulnerabilities || 0 : 0}</div>
        <div class="stat">HIGH: ${result.statistics ? result.statistics.highVulnerabilities || 0 : 0}</div>
        <div class="stat">MEDIUM: ${result.statistics ? result.statistics.mediumVulnerabilities || 0 : 0}</div>
        <div class="stat">LOW: ${result.statistics ? result.statistics.lowVulnerabilities || 0 : 0}</div>
    </div>
    <h2>–£—è–∑–≤–∏–º–æ—Å—Ç–∏</h2>
    ${result.vulnerabilities ? result.vulnerabilities.map(v => `
        <div class="vuln">
            <h3>${v.title || '–£—è–∑–≤–∏–º–æ—Å—Ç—å'}</h3>
            <p><strong>Severity:</strong> ${v.severity || 'UNKNOWN'}</p>
            <p><strong>Endpoint:</strong> ${v.endpoint || 'N/A'} [${v.method || 'N/A'}]</p>
            <p><strong>Description:</strong> ${v.description || ''}</p>
            ${v.recommendation ? `<p><strong>Recommendation:</strong> ${v.recommendation}</p>` : ''}
            ${v.cwe ? `<p><strong>CWE:</strong> ${v.cwe}</p>` : ''}
        </div>
    `).join('') : '<p>–£—è–∑–≤–∏–º–æ—Å—Ç–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>'}
</body>
</html>`;
    }
</script>
</body>
</html>

